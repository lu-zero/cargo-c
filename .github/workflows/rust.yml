name: Rust

on: [push, pull_request]

jobs:

  rustfmt-clippy:

    name: Format and Clippy

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Run rustfmt
        run: |
          cargo fmt --all -- --check

      - name: Run clippy
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --all -- -D warnings --verbose


  Ubuntu-Nightly:

    name: Ubuntu-Nightly

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install grcov
        env:
          LINK: https://github.com/mozilla/grcov/releases/download
          GRCOV_VERSION: 0.8.7
        run: |
          curl -L "$LINK/v$GRCOV_VERSION/grcov-x86_64-unknown-linux-gnu.tar.bz2" |
          tar xj -C $HOME/.cargo/bin

      - name: Install nightly
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly
          components: llvm-tools-preview

      - name: Set up MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          cc: false

      - name: Run cargo clean
        run: |
          cargo clean

      - name: Run grcov
        id: coverage
        run: bash coverage.sh

      - name: Codecov upload
        uses: codecov/codecov-action@v3
        with:
          files: coverage.lcov

  Ubuntu-Stable:

    name: Ubuntu-Stable

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build
        run: |
          cargo build --verbose

      - name: Run tests
        run: |
          cargo test --verbose

  msvc-Nightly:

    name: msvc-Nightly

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install nightly
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly

      - name: Run tests
        run: |
          cargo test --no-fail-fast

  msvc-Stable:

    name: msvc-Stable

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build
        run: |
          cargo build --verbose

      - name: Run tests
        run: |
          cargo test --verbose

  mingw-Nightly:

    name: mingw-Nightly

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install nightly-gnu
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly-gnu

      - name: Run tests
        run: |
          cargo test --no-fail-fast

  mingw-Stable:

    name: mingw-Stable

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install stable-gnu
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-gnu

      - name: Run tests
        run: |
          cargo test --verbose
